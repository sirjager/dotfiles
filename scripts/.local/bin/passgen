#!/bin/sh
# ======================================================
# Generate strong random passwords using OpenSSL
# Features:
# - Safe symbols: !@#$%^*_-+=&*
# - Minimum counts for numbers, symbols, uppercase, lowercase
# - Optional echo to terminal and copy to clipboard
# Usage: ./genpass.sh [options]
# ======================================================

# | Entropy (bits) | Strength                    |
# | -------------- | --------------------------- |
# | < 40           | Weak                        |
# | 40‚Äì60          | Moderate                    |
# | 60‚Äì80          | Strong                      |
# | 80+            | Very strong / high security |


# ---------------- Default settings -------------------
LENGTH=64
ECHO_TO_TERMINAL=false
COPY_TO_CLIPBOARD=false
SHOW_PASS_ENTROPY=false

INCLUDE_NUMBERS=true
INCLUDE_SYMBOLS=true
INCLUDE_CAPITAL=true
INCLUDE_LOWERCASE=true

MIN_NUMBERS=8
MIN_SYMBOLS=8
MIN_CAPITAL=8
MIN_LOWERCASE=8


# ---------------- Check dependencies -----------------
check_deps() {
    local missing=0
    for cmd in openssl bc; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Dependency missing: $cmd"
            missing=1
        fi
    done
    if [ "$missing" -eq 1 ]; then
        echo "‚ùå Please install missing dependencies and try again."
        echo "Arch Linux: sudo pacman -S openssl bc"
        echo "Debian/Ubuntu: sudo apt install openssl bc"
        echo "Fedora/RHEL: sudo dnf install openssl bc"
        exit 1
    fi
}
check_deps

# ---------------- Help function ----------------------
show_help() {
    cat <<EOF
Usage: $0 [options]

Options:
  -l, --length <n>      Set password length (default: 64)
  -N, --numbers         Include numbers
      --no-numbers      Exclude numbers
  -S, --symbols         Include symbols
      --no-symbols      Exclude symbols
  -C, --capital         Include uppercase letters
      --no-caps         Exclude uppercase letters
  -L, --lowercase       Include lowercase letters
      --no-lowercase    Exclude lowercase letters
  --min-numbers <n>     Minimum numbers in password
  --min-symbols <n>     Minimum symbols in password
  --min-caps <n>        Minimum uppercase letters
  --min-lowercase <n>   Minimum lowercase letters
  -e, --echo            Print password to terminal
  -c, --copy            Copy password to clipboard (wl-copy/xclip)
  -h, --help            Show this help message and exit

Examples:
  $0 -l 128 -c --min-symbols 2 --min-caps 2
  $0 --no-symbols --length 64 --echo
EOF
}

calculate_entropy() {
    local pwd="$1"
    local charset_size="$2"
    # Use bc to compute log2(charset_size) * length
    local log2=$(echo "l($charset_size)/l(2)" | bc -l)
    local entropy=$(echo "$log2 * ${#pwd}" | bc -l)
    printf "üîí Password entropy: %.2f bits\n" "$entropy"
}

# ---------------- Parse CLI arguments -----------------
while [ $# -gt 0 ]; do
    case "$1" in
        --numbers | --num | -N) INCLUDE_NUMBERS=true ;;
        --no-numbers | --no-num) INCLUDE_NUMBERS=false ;;
        --symbols | --sym | -S) INCLUDE_SYMBOLS=true ;;
        --no-symbols | --no-sym) INCLUDE_SYMBOLS=false ;;
        --capital | --caps | -C) INCLUDE_CAPITAL=true ;;
        --no-capital | --no-caps) INCLUDE_CAPITAL=false ;;
        --lowercase | --lows | -L) INCLUDE_LOWERCASE=true ;;
        --no-lowercase | --no-lows) INCLUDE_LOWERCASE=false ;;
        --length | --len | -l) shift; LENGTH="$1" ;;
        --min-numbers) shift; MIN_NUMBERS="$1" ;;
        --min-symbols) shift; MIN_SYMBOLS="$1" ;;
        --min-caps) shift; MIN_CAPITAL="$1" ;;
        --min-lowercase) shift; MIN_LOWERCASE="$1" ;;
        --echo | --terminal | -e) ECHO_TO_TERMINAL=true ;;
        --copy | --yank | -c | -y) COPY_TO_CLIPBOARD=true ;;
        --entropy | --stats) SHOW_PASS_ENTROPY=true ;;
        -h | --help) show_help; exit 0 ;;
        *) echo "Unknown option: $1"; show_help; exit 1 ;;
    esac
    shift
done

# ---------------- Build charset -----------------------
CHARSET=""
$INCLUDE_NUMBERS && CHARSET="${CHARSET}0-9"
$INCLUDE_CAPITAL && CHARSET="${CHARSET}A-Z"
$INCLUDE_LOWERCASE && CHARSET="${CHARSET}a-z"
$INCLUDE_SYMBOLS && CHARSET="${CHARSET}!@#\\$%\\^*_\-+=&*"

# Ensure at least one class is selected
[ -z "$CHARSET" ] && { echo "‚ùå Error: No character classes selected."; exit 1; }

# ---------------- Generate minimum characters ---------
PW=""

[ "$MIN_NUMBERS" -gt 0 ] && PW="$PW$(openssl rand -base64 $((MIN_NUMBERS*2)) | tr -dc '0-9' | head -c "$MIN_NUMBERS")"
[ "$MIN_SYMBOLS" -gt 0 ] && PW="$PW$(openssl rand -base64 $((MIN_SYMBOLS*2)) | tr -dc '!@#\$%\^*_\-+=&*' | head -c "$MIN_SYMBOLS")"
[ "$MIN_CAPITAL" -gt 0 ] && PW="$PW$(openssl rand -base64 $((MIN_CAPITAL*2)) | tr -dc 'A-Z' | head -c "$MIN_CAPITAL")"
[ "$MIN_LOWERCASE" -gt 0 ] && PW="$PW$(openssl rand -base64 $((MIN_LOWERCASE*2)) | tr -dc 'a-z' | head -c "$MIN_LOWERCASE")"

# ---------------- Fill remaining length ---------------
REMAIN=$(( LENGTH - ${#PW} ))
[ "$REMAIN" -gt 0 ] && PW="$PW$(openssl rand -base64 $((REMAIN*2)) | tr -dc "$CHARSET" | head -c "$REMAIN")"

# ---------------- Shuffle password --------------------
PASSWORD=$(echo "$PW" | fold -w1 | shuf | tr -d '\n')


# ------------------------------------------------------
# Output handling
# ------------------------------------------------------
if $ECHO_TO_TERMINAL; then
    echo "$PASSWORD"
fi

if $SHOW_PASS_ENTROPY; then
    CHARSET_SIZE=$(echo -n "$CHARSET" | fold -w1 | sort -u | wc -l)
    calculate_entropy "$PASSWORD" "$CHARSET_SIZE"
fi

if $COPY_TO_CLIPBOARD; then
    if command -v wl-copy >/dev/null 2>&1; then
        printf "%s" "$PASSWORD" | wl-copy
        echo "‚úÖ Password copied to clipboard"
    elif command -v xclip >/dev/null 2>&1; then
        printf "%s" "$PASSWORD" | xclip -selection clipboard
        echo "‚úÖ Password copied to clipboard"
    else
        echo "‚ö†Ô∏è No clipboard utility found. Install 'wl-clipboard' or 'xclip'."
    fi
fi
