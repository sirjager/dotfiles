#!/usr/bin/env bash
#
# Minimal test script to read Chromium-based browser history safely
# Uses a temporary copy of the History file

CHROMIUM_HISTORY_PATHS=(
  "/mnt/storage/programs/brave/Brave-Browser/sirjager/History"
  # "/mnt/storage/programs/brave/Brave-Browser/5321ankur/History"
)

SQL_QUERY="
SELECT COALESCE(title, 'title: Missing') AS title,
       ' url: ' || url
FROM urls
ORDER BY last_visit_time DESC
LIMIT 20000;
"

for DB_PATH in "${CHROMIUM_HISTORY_PATHS[@]}"; do
    # Resolve symlinks and expand ~
    EXPANDED_DB=$(readlink -f "$DB_PATH")
    
    if [[ ! -f "$EXPANDED_DB" ]]; then
        echo "‚è≠Ô∏è Skipping missing DB: $EXPANDED_DB"
        continue
    fi

    echo "üìÇ Reading history from: $EXPANDED_DB"

    # Copy to temp file
    TMP_DB=$(mktemp /tmp/chromium_history.XXXXXX)
    cp "$EXPANDED_DB" "$TMP_DB"

    if [[ ! -f "$TMP_DB" ]]; then
        echo "‚ùå Failed to copy $EXPANDED_DB"
        continue
    fi

    # Query the copied DB
    sqlite3 "$TMP_DB" "$SQL_QUERY"

    # Cleanup temp copy
    rm -f "$TMP_DB"
done

